<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StartBot Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root { --bg-color: #f0f2f5; --card-bg: #ffffff; --primary: #007bff; --danger: #dc3545; --success: #28a745; --text-main: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding-bottom: 120px; color: var(--text-main); }
        .sticky-header { position: sticky; top: 0; z-index: 1000; background: var(--card-bg); padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .timer-display { font-size: 2.2rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .header-controls { display: flex; gap: 10px; }
        .btn-action { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; text-transform: uppercase; }
        .btn-start { background: var(--success); color: white; }
        .btn-ap { background: var(--danger); color: white; display: none; }
        .btn-action:disabled { background: #ccc; cursor: not-allowed; }
        .container { padding: 20px; }
        #sequence-stack { display: flex; flex-direction: column; gap: 10px; min-height: 100px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .card-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .card-type-start { border-left: 5px solid var(--primary); }
        .control-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .status-indicator { font-size: 0.9rem; font-weight: bold; color: #666; }
        .status-indicator.connected { color: var(--success); }
        .btn-connect { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; }
        
        /* New Log Button Style */
        .btn-log { display: block; width: 100%; margin-top: 20px; padding: 15px; background: transparent; border: 2px dashed #ccc; color: #666; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="timer-display" id="mainTimer">00:00</div>
        <div class="header-controls">
            <button id="btnStart" class="btn-action btn-start" onclick="sendCommand('START_SEQUENCE')" disabled>START</button>
            <button id="btnAP" class="btn-action btn-ap" onclick="sendCommand('POSTPONE')">AP (STOP)</button>
        </div>
    </div>

    <div class="container">
        <div id="sequence-stack">
            <div class="card card-type-start" id="card-0">
                <div class="card-title">Start Sequence</div>
                <p>Standard 5-4-1-Go</p>
            </div>
        </div>
        
        <button class="btn-log" onclick="downloadLog()">Download Race Log (CSV)</button>
    </div>

    <div class="control-bar">
        <div class="status-indicator" id="statusText">Disconnected</div>
        <button class="btn-connect" id="btnConnect" onclick="connectBluetooth()">Connect to Pi</button>
    </div>

    <script>
        const SERVICE_UUID = '00000001-710e-4a5b-8d75-3e5b444bc3cf';
        const RX_UUID      = '00000002-710e-4a5b-8d75-3e5b444bc3cf';
        const TX_UUID      = '00000003-710e-4a5b-8d75-3e5b444bc3cf';

        let bluetoothDevice;
        let rxCharacteristic;
        let speechEnabled = false;
        let logBuffer = ""; // Holds the incoming file parts

        // --- AUDIO ENGINE ---
        function speak(text) {
            if (!speechEnabled) return;
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.1; 
            window.speechSynthesis.speak(utterance);
        }

        // --- BLUETOOTH LOGIC ---
        async function connectBluetooth() {
            const statusText = document.getElementById('statusText');
            try {
                statusText.innerText = "Requesting...";
                speechEnabled = true;
                speak("Connected. Ready.");

                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'StartBot' }],
                    optionalServices: [SERVICE_UUID]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(RX_UUID);
                const txCharacteristic = await service.getCharacteristic(TX_UUID);
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                statusText.innerText = "Connected to Pi";
                statusText.classList.add("connected");
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('btnStart').disabled = false;

            } catch (error) {
                statusText.innerText = "Failed: " + error;
            }
        }

        function onDisconnected() {
            document.getElementById('statusText').innerText = "Disconnected";
            document.getElementById('statusText').classList.remove("connected");
            document.getElementById('btnConnect').style.display = 'block';
            document.getElementById('btnStart').disabled = true;
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            try {
                const data = JSON.parse(decoder.decode(value));
                
                // 1. Log File Handling
                if (data.log_chunk) {
                    logBuffer += data.log_chunk;
                }
                if (data.log_end) {
                    saveLogFile();
                }
                if (data.log_error) {
                    alert("Log Error: " + data.log_error);
                }

                // 2. Timer UI
                if (data.time !== undefined) {
                    const mins = Math.floor(data.time / 60);
                    const secs = data.time % 60;
                    document.getElementById('mainTimer').innerText = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    checkAudioTriggers(data.time);
                }
                
                // 3. Status Buttons
                if (data.status === "Running") {
                    document.getElementById('btnStart').style.display = 'none';
                    document.getElementById('btnAP').style.display = 'block';
                } else {
                    document.getElementById('btnStart').style.display = 'block';
                    document.getElementById('btnAP').style.display = 'none';
                }

            } catch (e) { console.error(e); }
        }

        function checkAudioTriggers(secondsLeft) {
            switch(secondsLeft) {
                case 305: speak("Sequence started. Five minutes to warning."); break;
                case 300: speak("Five minutes. Warning signal."); break;
                case 240: speak("Four minutes. Prep signal."); break;
                case 60:  speak("One minute. Long sound."); break;
                case 10:  speak("Ten seconds."); break;
                case 5:   speak("Five"); break;
                case 4:   speak("Four"); break;
                case 3:   speak("Three"); break;
                case 2:   speak("Two"); break;
                case 1:   speak("One"); break;
                case 0:   speak("Start! Go go go!"); break;
            }
        }

        async function sendCommand(cmdType) {
            if (!rxCharacteristic) return;
            const payload = JSON.stringify({ command: cmdType });
            const encoder = new TextEncoder('utf-8');
            await rxCharacteristic.writeValue(encoder.encode(payload));
            
            if (cmdType === 'START_SEQUENCE') speak("Starting sequence.");
            if (cmdType === 'POSTPONE') speak("Race Postponed.");
        }

        function downloadLog() {
            if (!rxCharacteristic) {
                alert("Connect to Pi first!");
                return;
            }
            // Clear buffer and ask Pi for data
            logBuffer = "";
            sendCommand("GET_LOG");
            alert("Requesting Log... Wait for download.");
        }

        function saveLogFile() {
            const blob = new Blob([logBuffer], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'race_log.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            alert("Log Downloaded!");
        }
    </script>
</body>
</html>
