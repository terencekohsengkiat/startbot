<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StartBot Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --text-main: #333;
            --text-light: #666;
            --disabled: #e9ecef;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            padding-bottom: 120px;
        }

        /* --- STICKY HEADER --- */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--card-bg);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-display {
            font-size: 2.2rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            color: var(--text-main);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-start { background-color: var(--success); color: white; }
        .btn-ap { background-color: var(--danger); color: white; display: none; } /* Hidden by default */
        
        .btn-action:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- CONTAINER --- */
        .container { padding: 20px; }

        /* --- CARD STACK --- */
        #sequence-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 100px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            touch-action: none;
            transition: opacity 0.3s;
        }

        .card.completed {
            background-color: var(--disabled);
            opacity: 0.7;
        }
        .card.completed .card-title { text-decoration: line-through; color: #666; }
        .card.completed select { pointer-events: none; background: transparent; border: none; }
        .card.completed .btn-remove { display: none; }

        .card::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            width: 2px;
            height: 15px;
            background-color: #ddd;
            z-index: -1;
        }
        .card:last-child::after { display: none; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .card-type-gap { border-left: 5px solid #ffc107; }
        .card-type-start { border-left: 5px solid var(--primary); }
        .btn-remove { background: none; border: none; color: var(--danger); font-size: 1.5rem; cursor: pointer; padding: 0 10px; }

        .form-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        label { font-size: 0.9rem; color: var(--text-light); }
        select { padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 1rem; background: #fff; width: 60%; }

        .add-buttons { display: flex; justify-content: center; gap: 20px; margin-top: 30px; }
        .btn-add { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-add-start { background-color: var(--primary); color: white; }
        .btn-add-gap { background-color: #ffc107; color: white; }

        /* --- CONTROL BAR --- */
        .control-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--card-bg);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .status-indicator { font-size: 0.9rem; font-weight: bold; color: var(--text-light); }
        .status-indicator.connected { color: var(--success); }
        .btn-connect { background-color: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 1rem; cursor: pointer; }

        .drag-handle { color: #bbb; margin-right: 15px; cursor: grab; font-size: 1.5rem; padding: 5px; }

    </style>
</head>
<body>

    <div class="sticky-header">
        <div class="timer-display" id="mainTimer">00:00</div>
        <div class="header-controls">
            <button id="btnStart" class="btn-action btn-start" onclick="sendCommand('START_SEQUENCE')" disabled>START</button>
            <button id="btnAP" class="btn-action btn-ap" onclick="sendCommand('POSTPONE')">AP (STOP)</button>
        </div>
    </div>

    <div class="container">
        <div id="sequence-stack">
            </div>

        <div class="add-buttons">
            <button class="btn-add btn-add-start" onclick="addStartCard()" title="Add Start Sequence">⛵</button>
            <button class="btn-add btn-add-gap" onclick="addGapCard()" title="Add Time Gap">⏳</button>
        </div>
        
        <div style="text-align:center; margin-top:40px; border-top:1px solid #ddd; padding-top:20px;">
            <button onclick="downloadLog()" style="background:none; border:1px solid #999; padding:8px; border-radius:5px;">Download Log</button>
        </div>
    </div>

    <div class="control-bar">
        <div class="status-indicator" id="statusText">Disconnected</div>
        <button class="btn-connect" id="btnConnect" onclick="connectBluetooth()">Connect to Pi</button>
    </div>

    <script>
        // --- CONFIGURATION (Must match Python) ---
        const SERVICE_UUID = '00000001-710e-4a5b-8d75-3e5b444bc3cf';
        const RX_UUID      = '00000002-710e-4a5b-8d75-3e5b444bc3cf'; // Phone writes here
        const TX_UUID      = '00000003-710e-4a5b-8d75-3e5b444bc3cf'; // Pi notifies here

        let cardIdCounter = 0;
        let bluetoothDevice;
        let rxCharacteristic;
        let eventLog = [];

        // --- UI FUNCTIONS ---
        const stackElement = document.getElementById('sequence-stack');
        new Sortable(stackElement, { animation: 150, handle: '.drag-handle' });

        function addStartCard() {
            const id = cardIdCounter++;
            const cardHTML = `
                <div class="card card-type-start" id="card-${id}">
                    <div class="card-header">
                        <div><span class="drag-handle">☰</span><span class="card-title">Start Sequence</span></div>
                        <button class="btn-remove" onclick="removeCard(${id})">&times;</button>
                    </div>
                    <div class="form-row"><label>Class</label><select id="class-${id}"><option value="ILCA">ILCA</option><option value="Opti">Optimist</option></select></div>
                    <div class="form-row"><label>Prep</label><select id="prep-${id}"><option value="P">P Flag</option><option value="U">U Flag</option><option value="Black">Black Flag</option></select></div>
                </div>`;
            stackElement.insertAdjacentHTML('beforeend', cardHTML);
        }

        function addGapCard() {
            const id = cardIdCounter++;
            const cardHTML = `
                <div class="card card-type-gap" id="card-${id}">
                    <div class="card-header">
                        <div><span class="drag-handle">☰</span><span class="card-title">Gap</span></div>
                        <button class="btn-remove" onclick="removeCard(${id})">&times;</button>
                    </div>
                    <div class="form-row"><label>Duration</label><select id="gap-${id}"><option value="0">Rolling (Immediate)</option><option value="1">1 Min Delay</option></select></div>
                </div>`;
            stackElement.insertAdjacentHTML('beforeend', cardHTML);
        }

        function removeCard(id) { document.getElementById(`card-${id}`).remove(); }

        // --- BLUETOOTH LOGIC ---

        async function connectBluetooth() {
            const statusText = document.getElementById('statusText');
            try {
                statusText.innerText = "Requesting Device...";
                
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'StartBot' }],
                    optionalServices: [SERVICE_UUID]
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                statusText.innerText = "Connecting...";
                const server = await bluetoothDevice.gatt.connect();
                
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // Setup Receive (RX) to write commands
                rxCharacteristic = await service.getCharacteristic(RX_UUID);
                
                // Setup Transmit (TX) to listen for time updates
                const txCharacteristic = await service.getCharacteristic(TX_UUID);
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                // Success
                statusText.innerText = "Connected to Pi";
                statusText.classList.add("connected");
                document.getElementById('btnConnect').style.display = 'none';
                document.getElementById('btnStart').disabled = false;

            } catch (error) {
                console.error(error);
                statusText.innerText = "Connection Failed: " + error;
            }
        }

        function onDisconnected() {
            document.getElementById('statusText').innerText = "Disconnected";
            document.getElementById('statusText').classList.remove("connected");
            document.getElementById('btnConnect').style.display = 'block';
            document.getElementById('btnStart').disabled = true;
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const dataStr = decoder.decode(value);
            
            try {
                const data = JSON.parse(dataStr);
                
                // Update Timer
                if (data.time !== undefined) {
                    const mins = Math.floor(data.time / 60);
                    const secs = data.time % 60;
                    document.getElementById('mainTimer').innerText = 
                        `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                
                // Update UI State based on Pi status
                if (data.status === "Running") {
                    document.getElementById('btnStart').style.display = 'none';
                    document.getElementById('btnAP').style.display = 'block';
                } else {
                    document.getElementById('btnStart').style.display = 'block';
                    document.getElementById('btnAP').style.display = 'none';
                }

            } catch (e) {
                console.error("Parse Error:", e);
            }
        }

        async function sendCommand(cmdType) {
            if (!rxCharacteristic) return;
            
            // Gather current settings from the top card
            const firstCard = document.querySelector('.card:not(.completed)');
            let settings = {};
            if(firstCard && firstCard.classList.contains('card-type-start')) {
                const id = firstCard.id.split('-')[1];
                settings = {
                    class: document.getElementById(`class-${id}`).value,
                    prep: document.getElementById(`prep-${id}`).value
                };
            }

            const payload = JSON.stringify({
                command: cmdType,
                settings: settings
            });

            const encoder = new TextEncoder('utf-8');
            await rxCharacteristic.writeValue(encoder.encode(payload));
        }

        function downloadLog() {
            // Placeholder for log logic
            alert("Log download will be requested from Pi in next version.");
        }

        // Init
        addStartCard();
    </script>
</body>
</html>
